<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Dashboard</title>
    <style>
        /* [Previous CSS styles remain exactly the same] */
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains the same] -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script>
        // State management
        let allProducts = [];
        let filteredProducts = [];
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchProducts();
            setupEventListeners();
            document.getElementById('loading').style.display = 'none';
        });

        // [Previous database loading and product fetching functions remain the same]

        // Display all filtered products with improved image handling
        function displayProducts() {
            const container = document.getElementById('product-container');
            container.innerHTML = filteredProducts.map(product => `
                <div class="product">
                    <div class="product-image-container">
                        <img class="product-image loading" 
                             data-src="${product.image_url}" 
                             alt="${product.title}"
                             onload="this.classList.remove('loading'); this.classList.add('loaded')"
                             onerror="retryImageLoad(this)">
                        <div class="image-loader"></div>
                    </div>
                    <div class="product-details">
                        <h2>${product.title}</h2>
                        <p><strong>SKU:</strong> ${product.sku}</p>
                        <p class="price">${product.price}</p>
                    </div>
                    <div class="product-actions">
                        <a href="${product.url}" target="_blank" rel="noopener noreferrer" class="action-button view-button">View Product</a>
                        <button class="action-button copy-button" onclick="copyProductDetails(this)">
                            Copy Details
                        </button>
                    </div>
                </div>
            `).join('');

            // Load images with multiple fallback strategies
            loadAllImages();
        }

        // Improved image loading with multiple fallback strategies
        function loadAllImages() {
            const images = document.querySelectorAll('.product-image[data-src]');
            
            images.forEach(img => {
                const originalSrc = img.getAttribute('data-src');
                if (!originalSrc || originalSrc === 'N/A') {
                    showFallbackImage(img);
                    return;
                }

                // Try multiple loading strategies
                tryImageLoad(img, originalSrc)
                    .catch(() => tryDirectLink(img, originalSrc))
                    .catch(() => tryProxy(img, originalSrc))
                    .catch(() => tryMainWebsite(img, originalSrc))
                    .catch(() => showFallbackImage(img));
            });
        }

        // Primary image loading strategy
        function tryImageLoad(img, src) {
            return new Promise((resolve, reject) => {
                img.src = fixImageUrl(src);
                img.onload = () => resolve();
                img.onerror = () => reject();
            });
        }

        // Try direct link if first attempt fails
        function tryDirectLink(img, src) {
            return new Promise((resolve, reject) => {
                // Remove any proxy or parameters
                const cleanUrl = src.split('?')[0].replace(/^https?:\/\/[^\/]+\//, '/');
                img.src = cleanUrl;
                img.onload = () => resolve();
                img.onerror = () => reject();
            });
        }

        // Try through a CORS proxy
        function tryProxy(img, src) {
            return new Promise((resolve, reject) => {
                const proxyUrl = `https://cors-anywhere.herokuapp.com/${src}`;
                img.src = proxyUrl;
                img.onload = () => resolve();
                img.onerror = () => reject();
            });
        }

        // Try to fetch from main website
        function tryMainWebsite(img, src) {
            return new Promise((resolve, reject) => {
                // Extract domain from product URL
                const productUrl = img.closest('.product').querySelector('a').href;
                const domain = new URL(productUrl).origin;
                const absoluteUrl = src.startsWith('http') ? src : domain + src;
                
                fetch(absoluteUrl, { mode: 'no-cors' })
                    .then(() => {
                        img.src = absoluteUrl;
                        resolve();
                    })
                    .catch(reject);
            });
        }

        // Show fallback image
        function showFallbackImage(img) {
            img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlna0hlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEwMCAxMDAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNmNWY1ZjUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIiBmaWxsPSIjNjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIj5JbWFnZSBOb3QgQXZhaWxhYmxlPC90ZXh0Pjwvc3ZnPg==';
            img.classList.remove('loading');
            img.classList.add('loaded');
        }

        // Retry loading with different strategies
        function retryImageLoad(img) {
            const originalSrc = img.getAttribute('data-src');
            if (!originalSrc) {
                showFallbackImage(img);
                return;
            }

            // Try alternative loading methods
            tryDirectLink(img, originalSrc)
                .catch(() => tryProxy(img, originalSrc))
                .catch(() => tryMainWebsite(img, originalSrc))
                .catch(() => showFallbackImage(img));
        }

        // Fix common image URL issues
        function fixImageUrl(url) {
            if (!url) return '';
            
            // Handle relative URLs
            if (url.startsWith('//')) {
                return 'https:' + url;
            }
            if (url.startsWith('/')) {
                return window.location.origin + url;
            }
            
            // Add cache-busting parameter
            return url.includes('?') ? `${url}&t=${Date.now()}` : `${url}?t=${Date.now()}`;
        }

        // [Rest of your existing JavaScript functions remain the same]
    </script>
</body>
</html>
